<launch>
  <arg name="use_sim_time" default="false" description="Use simulation clock if true"/>

  <let name="pkg_description" value="$(find-pkg-share my_robot_description)"/>
  <let name="pkg_bringup" value="$(find-pkg-share my_robot_bringup)"/>
  <let name="urdf_file" value="$(var pkg_description)/urdf/my_robot_main.urdf.xacro"/>
  <let name="controller_config" value="$(var pkg_bringup)/config/my_controller.yaml"/>
  <let name="rviz_config" value="$(var pkg_description)/rviz/rviz_config.rviz"/>
  <let name="gazebo_bridge_config" value="$(var pkg_bringup)/config/gazebo_bridge.yaml"/>

  <!-- <node name="joint_state_publisher" pkg="joint_state_publisher_gui" exec="joint_state_publisher_gui" /> -->

  <node pkg="robot_state_publisher" exec="robot_state_publisher">
    <param name="robot_description" value="$(command 'xacro $(var urdf_file)')"/>
    <param name="use_sim_time" value="$(var use_sim_time)"/>
  </node>

  <group unless="$(var use_sim_time)">
    <node pkg="controller_manager" exec="ros2_control_node" output="screen">
      <param name="robot_description" value="$(command 'xacro $(var urdf_file)')"/>
      <param from="$(var controller_config)"/>
    </node>
  </group>

 <group if="$(var use_sim_time)">
    <include file="$(find-pkg-share ros_gz_sim)/launch/gz_sim.launch.py">
      <arg name="gz_args" value="empty.sdf -r"/>
    </include>

    <node pkg="ros_gz_sim" exec="create" args="-topic robot_description"/>

    <node pkg="ros_gz_bridge" exec="parameter_bridge" name="ros_gz_bridge" output="screen" 
        args="--ros-args --params-file $(var gazebo_bridge_config)">
    <param name="use_sim_time" value="$(var use_sim_time)"/>
    </node>
  </group>

  <node pkg="controller_manager" exec="spawner" args="joint_state_broadcaster"/>
  <node pkg="controller_manager" exec="spawner" args="diff_drive_controller"/>

  <node pkg="rviz2" exec="rviz2" args="-d $(var rviz_config)">
    <param name="use_sim_time" value="$(var use_sim_time)"/>
  </node>
</launch>